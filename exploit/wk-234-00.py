# -*- coding:utf-8 -*- 
#!/usr/bin/env python3
#Description: wukong exploit 
#Author:      Bing
#Email:       amzing_bing@outlook.com
#DateTime:    2017-05-10 23:08:39

import sys
sys.path.append("..")

import socket
from exploit.module.example import WKExploit

class Exploit(WKExploit) :
	def __init__(self, args) :
		'''
		漏洞信息和测试参数
		'''
		self.info = {
			# 输入参数
			"protorl" : self.parameter(args["protorl"],"http://"),
			"host" : self.parameter(args["host"], ""), 
			"port" : self.parameter(args["port"], "6379"),
			"cookie" : self.parameter(args["cookie"], ""),
			"fuzzing" : self.custom_fuzzing_api("brute","redis") ,
		}

		self.result = {
			# 结果信息
			"status" : False,
			"data" : [{
				"bug_name" : "redis弱口令",
				"bug_author" : "Bing",
				"bug_level" : self.level.high,
				"bug_type" : self.category.misconfiguration,
				"bug_ref" : "",
				"bug_desc" : "",
				"bug_result" : [],
				"bug_repair" : "修改弱口令，并设置强密码"
			}],
		}

	def check(self, txt):
		'''
		漏洞验证
		'''
		host = self.info["host"]
		port = self.info["port"]
		password = txt

		try:
			s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
			s.settimeout(2)
			s.connect( (host,int(port)) )
			s.send('INFO\r\n'.encode())
			result = s.recv(1024).__str__()
			if "redis_version" in result:
				self.result["status"] = True
				if "unauthorized" in self.result["data"][0]["bug_result"] :
					pass
				else:
					print(password,"----")
					self.result["data"][0]["bug_result"].append("unauthorized")
			else:
				s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
				s.connect( (host,int(port)) )
				s.send( ("AUTH %s\r\n" % (password) ).encode() )
				result = s.recv(1024).__str__()
				if '+OK' in result:
					self.result["status"] = True
					if password in self.result["data"][0]["bug_result"] :
						pass
					else:
						self.result["data"][0]["bug_result"].append(password)
		except Exception as e:
			pass



